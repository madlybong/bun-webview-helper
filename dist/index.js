// @bun
var d=Object.create;var{getPrototypeOf:f,defineProperty:s,getOwnPropertyNames:w}=Object;var W=Object.prototype.hasOwnProperty;var c=(H,_,e)=>{e=H!=null?d(f(H)):{};const A=_||!H||!H.__esModule?s(e,"default",{value:H,enumerable:!0}):e;for(let L of w(H))if(!W.call(A,L))s(A,L,{get:()=>H[L],enumerable:!0});return A};var l=(H,_)=>()=>(_||H((_={exports:{}}).exports,_),_.exports);var u=l((N,S)=>{S.exports="./libwebview-x569zfta.dll"});var D=l((m,M)=>{M.exports="./libwebview-yvy5xxrv.dylib"});import n from"lodash";import{dlopen as T,FFIType as t,ptr as h}from"bun:ffi";function I(H){return h(new TextEncoder().encode(H+"\0"))}var v=[],r;if(process.env.WEBVIEW_PATH)r=await import(process.env.WEBVIEW_PATH);else if(process.platform==="win32")r=await Promise.resolve().then(() => c(u(),1));else if(process.platform==="linux")r=await import(`../build/libwebview-${process.arch}.so`);else if(process.platform==="darwin")r=await Promise.resolve().then(() => c(D(),1));else throw`unsupported platform: ${process.platform}-${process.arch}`;var $=T(r.default,{webview_create:{args:[t.i32,t.ptr],returns:t.ptr},webview_destroy:{args:[t.ptr],returns:t.void},webview_run:{args:[t.ptr],returns:t.void},webview_terminate:{args:[t.ptr],returns:t.void},webview_get_window:{args:[t.ptr],returns:t.ptr},webview_set_title:{args:[t.ptr,t.ptr],returns:t.void},webview_set_size:{args:[t.ptr,t.i32,t.i32,t.i32],returns:t.void},webview_navigate:{args:[t.ptr,t.ptr],returns:t.void},webview_set_html:{args:[t.ptr,t.ptr],returns:t.void},webview_init:{args:[t.ptr,t.ptr],returns:t.void},webview_eval:{args:[t.ptr,t.ptr],returns:t.void},webview_bind:{args:[t.ptr,t.ptr,t.function,t.ptr],returns:t.void},webview_unbind:{args:[t.ptr,t.ptr],returns:t.void},webview_return:{args:[t.ptr,t.ptr,t.i32,t.ptr],returns:t.void}});import{CString as P,FFIType as o,JSCallback as U}from"bun:ffi";class C{#H=null;#t=new Map;get unsafeHandle(){return this.#H}get unsafeWindowHandle(){return $.symbols.webview_get_window(this.#H)}set size({width:H,height:_,hint:e}){$.symbols.webview_set_size(this.#H,H,_,e)}set title(H){$.symbols.webview_set_title(this.#H,I(H))}constructor(H=!1,_={width:1024,height:768,hint:0},e=null){if(this.#H=typeof H==="bigint"||typeof H==="number"?H:$.symbols.webview_create(Number(H),e),_!==void 0)this.size=_;v.push(this)}destroy(){for(let H of this.#t.keys())this.unbind(H);$.symbols.webview_terminate(this.#H),$.symbols.webview_destroy(this.#H),this.#H=null}navigate(H){$.symbols.webview_navigate(this.#H,I(H))}setHTML(H){$.symbols.webview_set_html(this.#H,I(H))}run(){$.symbols.webview_run(this.#H),this.destroy()}bindRaw(H,_,e=null){const A=new U((L,E,i)=>{const a=L?new P(L):"",p=E?new P(E):"";_(a,p,i)},{args:[o.pointer,o.pointer,o.pointer],returns:o.void});this.#t.set(H,A),$.symbols.webview_bind(this.#H,I(H),A.ptr,e)}bind(H,_){this.bindRaw(H,(e,A)=>{const L=JSON.parse(A);let E,i;try{E=_(...L),i=!0}catch(a){E=a,i=!1}if(E instanceof Promise)E.then((a)=>this.return(e,i?0:1,JSON.stringify(a)));else this.return(e,i?0:1,JSON.stringify(E))})}unbind(H){$.symbols.webview_unbind(this.#H,I(H)),this.#t.get(H)?.close(),this.#t.delete(H)}return(H,_,e){$.symbols.webview_return(this.#H,I(H),_,I(e))}eval(H){$.symbols.webview_eval(this.#H,I(H))}init(H){$.symbols.webview_init(this.#H,I(H))}}async function F({config:H}={config:b}){try{const _=n.map(H?.actions,(E,i)=>{return`wv.bind("${i}", ${E});`}),e=new Blob(n.flatten(n.concat(["declare var self: Worker;",'import { SizeHint, Webview } from "webview-bun";','import _ from "lodash";',`const wv = new Webview(true, {
              width: ${H?.width},
              height: ${H?.height},
              hint: ${H?.hint},
          });`],n.isArray(_)?_:[],[`wv.title = '${H?.title||"New Window"}';`,`wv.setHTML('${H?.html}');`,`wv.navigate('${H?.navigationUrl}');`,"wv.run();"])),{type:"application/typescript"}),A=URL.createObjectURL(e),L=new Worker(A,{type:"module"});return L.addEventListener("open",()=>{console.log("New worker.")}),L.addEventListener("error",(E)=>{console.log("Worker error.",E)}),L}catch(_){return _}}var b={width:800,height:600,hint:0,title:"New Window",html:void 0,navigationUrl:void 0,actions:{}};export{F as wvWorker};
